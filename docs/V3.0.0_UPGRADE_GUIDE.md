# intell-swe v3.0.0 Upgrade Guide

**Release Date**: January 26, 2026  
**Previous Version**: rag-poc v2.4.0  
**New Repository**: https://github.com/reginaldrhoe/intell-swe

---

## Overview

Version 3.0.0 represents a **major architectural transformation** from single-user proof-of-concept (rag-poc v2.4.0) to enterprise-grade multiuser framework (intell-swe v3.0.0). This release introduces fundamental changes to database schema, authentication, API design, and deployment architecture.

### Key Changes

| Area | v2.4.0 (rag-poc) | v3.0.0 (intell-swe) |
|------|------------------|---------------------|
| **User Model** | Single-user, bearer token demo | Multiuser with GitLab OAuth, RBAC |
| **Database** | SQLite-only | PostgreSQL-first (SQLite fallback) |
| **Task Scoping** | Global task list | Per-user isolation with admin visibility |
| **Repository Access** | Direct clone per task | Central bare mirror + lightweight worktrees |
| **SSE Channels** | Global task events | User-namespaced: `tasks:{user_id}:{task_id}` |
| **Deployment** | Individual instances | Centralized shared framework |
| **Schema Management** | Manual SQL | Alembic migrations |

---

## Prerequisites

### Required Software
- **Python 3.11+** (verified: `python --version`)
- **Docker & Docker Compose** (v2.x recommended)
- **PostgreSQL 13+** (for production deployment)
- **GitLab Account** (for OAuth authentication)

### Required Accounts/Services
- GitLab OAuth Application (Client ID + Secret)
- OpenAI API Key (for LLM functionality)
- Qdrant instance (bundled via Docker Compose)

---

## Migration Path

### Option 1: Clean Slate Deployment (Recommended)

Best for production environments requiring fresh PostgreSQL instance and clean multiuser setup.

#### Step 1: Deploy intell-swe v3.0.0

```powershell
# Clone new repository
git clone https://github.com/reginaldrhoe/intell-swe.git
cd intell-swe

# Create .env file
cp .env.example .env
```

#### Step 2: Configure Environment

Edit `.env`:

```env
# Database (PostgreSQL for production)
DATABASE_URL=postgresql://user:password@postgres:5432/intell_swe

# GitLab OAuth
GITLAB_OAUTH_CLIENT_ID=your_client_id_here
GITLAB_OAUTH_CLIENT_SECRET=your_secret_here
GITLAB_OAUTH_REDIRECT_URI=https://your-domain.com/oauth/callback

# OpenAI
OPENAI_API_KEY=sk-your-key-here

# Qdrant
QDRANT_URL=http://qdrant:6333

# Redis
CELERY_BROKER_URL=redis://redis:6379/0
```

#### Step 3: Initialize Database

```powershell
# Run Alembic migrations
docker compose run --rm mcp alembic upgrade head

# Verify schema
docker compose exec postgres psql -U user -d intell_swe -c "\dt"
```

#### Step 4: Create Admin User

```powershell
# SQL seed script (run once)
docker compose exec postgres psql -U user -d intell_swe <<EOF
INSERT INTO users (id, username, email, role, created_at)
VALUES (
  'admin-001',
  'admin',
  'admin@yourcompany.com',
  'admin',
  NOW()
);
EOF
```

#### Step 5: Start Services

```powershell
docker compose up -d
```

#### Step 6: Verify Deployment

```powershell
# Health check
curl http://localhost:8001/health

# Admin endpoint (requires admin token)
curl -H "Authorization: Bearer admin-token" http://localhost:8001/admin/tasks

# Prometheus metrics
curl http://localhost:8001/metrics
```

---

### Option 2: Data Migration (Advanced)

For migrating existing v2.4.0 data to v3.0.0 with user attribution.

#### Step 1: Backup v2.4.0 Data

```powershell
cd C:\MySQL\agentic_rag_poc

# Export tasks from SQLite
docker compose exec mcp python -c "
from mcp.db import SessionLocal
from mcp.models import Task
import json

db = SessionLocal()
tasks = db.query(Task).all()
data = [{
    'id': t.id,
    'title': t.title,
    'description': t.description,
    'status': t.status,
    'created_at': str(t.created_at)
} for t in tasks]

with open('/app/tasks_backup.json', 'w') as f:
    json.dump(data, f, indent=2)
"

# Copy backup out
docker compose cp mcp:/app/tasks_backup.json ./tasks_backup_v2.4.0.json
```

#### Step 2: Import to v3.0.0 with User Attribution

```powershell
cd C:\MySQL\intell_swe

# Create migration user
docker compose exec postgres psql -U user -d intell_swe -c "
INSERT INTO users (id, username, email, role)
VALUES ('migration-user', 'legacy-user', 'legacy@yourcompany.com', 'user');
"

# Import tasks (assign to migration user)
docker compose exec mcp python -c "
from mcp.db import SessionLocal
from mcp.models import Task
import json

db = SessionLocal()

with open('/path/to/tasks_backup_v2.4.0.json') as f:
    tasks = json.load(f)

for t in tasks:
    new_task = Task(
        title=t['title'],
        description=t['description'],
        status=t['status'],
        user_id='migration-user',  # Assign to migration user
        repo_ref='unknown',
        branch='main'
    )
    db.add(new_task)

db.commit()
"
```

---

## Configuration Changes

### Environment Variables

#### Removed in v3.0.0
- `DEMO_MODE` (replaced by OAuth)
- `SINGLE_USER_TOKEN` (replaced by user sessions)

#### New in v3.0.0
```env
DATABASE_URL=postgresql://...      # PostgreSQL connection string
GITLAB_OAUTH_CLIENT_ID=...         # GitLab OAuth client ID
GITLAB_OAUTH_CLIENT_SECRET=...     # GitLab OAuth secret
GITLAB_OAUTH_REDIRECT_URI=...      # OAuth callback URL
ENABLE_ADMIN_ENDPOINTS=true        # Enable admin APIs
USER_TASK_RETENTION_DAYS=90        # Auto-cleanup old tasks
WORKTREE_LRU_MAX_COUNT=50          # Worktree cache size
```

### Docker Compose Changes

#### New Services
- `postgres` - PostgreSQL database (preferred over SQLite)
- `prometheus` - Metrics collection

#### Modified Services
- `mcp` - Now includes Alembic migrations, user authentication
- `worker` - Now processes tasks with user context
- `frontend` - Updated for multiuser UI

---

## API Changes

### Authentication

#### Before (v2.4.0)
```bash
curl -H "Authorization: Bearer demo" http://localhost:8001/tasks
```

#### After (v3.0.0)
```bash
# Obtain user token via OAuth flow
curl -H "Authorization: Bearer <user-session-token>" http://localhost:8001/tasks
```

### Task Creation

#### Before (v2.4.0)
```json
POST /tasks
{
  "title": "Analyze code",
  "description": "Review changes"
}
```

#### After (v3.0.0)
```json
POST /tasks
{
  "title": "Analyze code",
  "description": "Review changes",
  "repo_ref": "https://github.com/user/repo",
  "branch": "main"
}
# user_id automatically injected from auth token
```

### Admin Endpoints (New in v3.0.0)

```bash
# View all tasks (admin only)
GET /admin/tasks

# View all users (admin only)
GET /admin/users

# Cross-user metrics (admin only)
GET /admin/metrics
```

---

## Testing

### Unit Tests

```powershell
# Activate virtual environment
.venv\Scripts\Activate.ps1

# Run tests
pytest -q
```

### E2E Integration Tests

```powershell
# Run with mock services
python scripts/run_e2e_integration.py --mock

# Verify health diagnostics
python -c "import requests; r=requests.get('http://localhost:8001/health'); print(r.json())"
```

### Agent Smoke Tests

```powershell
python scripts/run_agent_smoke2.py
```

---

## Rollback Plan

If issues arise during v3.0.0 deployment:

### Step 1: Stop v3.0.0 Services

```powershell
cd C:\MySQL\intell_swe
docker compose down
```

### Step 2: Restore v2.4.0

```powershell
cd C:\MySQL\agentic_rag_poc
docker compose up -d

# Restore v2.4.0 SQLite database from backup
docker compose cp ./backup_v2.4.0.db mcp:/app/tasks.db
docker compose restart mcp
```

### Step 3: Verify v2.4.0 Restoration

```bash
curl http://localhost:8001/health
curl -H "Authorization: Bearer demo" http://localhost:8001/tasks
```

---

## Troubleshooting

### Issue: Database connection errors

**Symptom**: `sqlalchemy.exc.OperationalError: could not connect to server`

**Solution**:
```powershell
# Check PostgreSQL is running
docker compose ps postgres

# Verify DATABASE_URL in .env
echo $env:DATABASE_URL

# Test connection
docker compose exec postgres psql -U user -d intell_swe -c "SELECT 1;"
```

### Issue: OAuth redirect fails

**Symptom**: `Invalid redirect_uri`

**Solution**:
1. Verify `GITLAB_OAUTH_REDIRECT_URI` matches GitLab app configuration
2. Ensure URI includes protocol (https://) and exact path (`/oauth/callback`)
3. Check GitLab OAuth app settings for correct redirect URI

### Issue: Tasks not scoped to user

**Symptom**: Users see tasks from other users

**Solution**:
```powershell
# Verify user_id is being injected
docker compose logs mcp | Select-String "user_id"

# Check authentication middleware
curl -H "Authorization: Bearer <token>" http://localhost:8001/me
```

### Issue: Alembic migration fails

**Symptom**: `alembic.util.exc.CommandError: Can't locate revision`

**Solution**:
```powershell
# Reset Alembic state
docker compose exec postgres psql -U user -d intell_swe -c "DROP TABLE IF EXISTS alembic_version;"

# Re-run migrations
docker compose run --rm mcp alembic upgrade head
```

---

## Support & Resources

- **GitHub Repository**: https://github.com/reginaldrhoe/intell-swe
- **Release Notes**: [v3.0.0-release.md](../v3.0.0-release.md)
- **Architecture Documentation**: [docs/architecture/ARCHITECTURE_ANALYSIS.md](architecture/ARCHITECTURE_ANALYSIS.md)
- **User Manual**: [docs/manuals/USER_MANUAL.md](manuals/USER_MANUAL.md)
- **Operation Manual**: [docs/manuals/OPERATION_MANUAL.md](manuals/OPERATION_MANUAL.md)

---

**Document Version**: 3.0.0  
**Last Updated**: January 26, 2026
