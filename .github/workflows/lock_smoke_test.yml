name: Lock sentinel smoke test

on:
  workflow_dispatch: {}
  push:
    branches: [ ci/dispatch-qdrant, main ]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build MCP image
        run: |
          docker compose build mcp

      - name: Create minimal .env for CI
        run: |
          cat > .env <<'EOF'
          OPENAI_API_KEY=sk-mock-key
          DATABASE_URL=sqlite:///./test.db
          MYSQL_ROOT_PASSWORD=rootpass
          MYSQL_DATABASE=ragpoc
          MYSQL_USER=raguser
          MYSQL_PASSWORD=ragpass
          EOF

      - name: Start services
        run: |
          docker compose up -d redis qdrant mcp worker openai-mock

      - name: Export OpenAI base for CI
        run: |
          echo "OPENAI_API_BASE=http://localhost:1573" >> $GITHUB_ENV

      - name: Wait for OpenAI mock
        run: |
          for i in $(seq 1 30); do
            if curl -sS http://localhost:1573/v1/embeddings -X POST -H 'Content-Type: application/json' -d '{"input":"ping","model":"text-embedding-mock"}' >/dev/null 2>&1; then
              echo "OpenAI mock is ready"; exit 0
            fi
            sleep 1
          done
          echo "OpenAI mock did not become ready"; docker compose logs openai-mock; exit 1

      - name: Wait for MCP health
        run: |
          for i in $(seq 1 30); do
            if curl -sS http://localhost:8001/health >/dev/null 2>&1; then
              echo "MCP is healthy"; exit 0
            fi
            sleep 2
          done
          echo "MCP did not become healthy"; docker compose logs mcp; exit 1

      - name: Install Python deps
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install requests

      - name: Create Test Task
        run: |
          python3 - <<'PY'
          import requests, json, sys
          url = 'http://localhost:8001/api/tasks'
          headers = {'Authorization':'Bearer demo'}
          payload = {'title':'ci-lock-smoke','description':'created by CI smoke test'}
          resp = requests.post(url, json=payload, headers=headers)
          try:
              resp.raise_for_status()
          except Exception:
              print('Failed to create task:', resp.status_code, resp.text)
              raise
          data = resp.json()
          # Try common id locations
          task_id = None
          if isinstance(data, dict):
              task_id = data.get('id') or data.get('task', {}).get('id') or data.get('data', {}).get('id')
          if not task_id:
              print('Could not determine task id from response:', data)
              raise SystemExit(2)
          print('Created task id:', task_id)
          with open('task_id.txt', 'w') as f:
              f.write(str(task_id))
          PY

      - name: Run smoke test
        run: |
          TASK_ID=$(cat task_id.txt)
          echo "Using task id: $TASK_ID"
          python3 scripts/run_lock_smoke.py --task-id $TASK_ID

      - name: Tear down
        if: always()
        run: |
          docker compose down

  e2e-mock:
    needs: smoke-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build MCP image
        run: |
          docker compose build mcp

      - name: Create minimal .env for CI
        run: |
          cat > .env <<'EOF'
          OPENAI_API_KEY=sk-mock-key
          DATABASE_URL=sqlite:///./test.db
          MYSQL_ROOT_PASSWORD=rootpass
          MYSQL_DATABASE=ragpoc
          MYSQL_USER=raguser
          MYSQL_PASSWORD=ragpass
          EOF

      - name: Start services
        run: |
          docker compose up -d redis qdrant mcp worker openai-mock

      - name: Export OpenAI base for CI
        run: |
          echo "OPENAI_API_BASE=http://localhost:1573" >> $GITHUB_ENV

      - name: Wait for OpenAI mock
        run: |
          for i in $(seq 1 30); do
            if curl -sS http://localhost:1573/v1/embeddings -X POST -H 'Content-Type: application/json' -d '{"input":"ping","model":"text-embedding-mock"}' >/dev/null 2>&1; then
              echo "OpenAI mock is ready"; exit 0
            fi
            sleep 1
          done
          echo "OpenAI mock did not become ready"; docker compose logs openai-mock; exit 1

      - name: Wait for MCP health
        run: |
          for i in $(seq 1 30); do
            if curl -sS http://localhost:8001/health >/dev/null 2>&1; then
              echo "MCP is healthy"; exit 0
            fi
            sleep 2
          done
          echo "MCP did not become healthy"; docker compose logs mcp; exit 1

      - name: Install Python deps
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install requests

      - name: Run E2E in mock mode
        run: |
          set -o pipefail
          python3 scripts/run_e2e_integration.py --mock 2>&1 | tee e2e_output.txt

      - name: Collect container logs
        if: always()
        run: |
          docker compose logs --no-color mcp > mcp.log 2>&1 || true
          docker compose logs --no-color worker > worker.log 2>&1 || true
          docker compose logs --no-color qdrant > qdrant.log 2>&1 || true
          docker compose logs --no-color openai-mock > openai-mock.log 2>&1 || true

      - name: Upload E2E artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-mock-logs
          path: |
            e2e_output.txt
            mcp.log
            worker.log
            qdrant.log
            openai-mock.log

      - name: Tear down
        if: always()
        run: |
          docker compose down
